#!/usr/bin/env bash
set -ex

cd $(dirname $0)/..

source ./scripts/version.sh
export DOCKER_CLI_EXPERIMENTAL=enabled

set +x
docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
set -x

docker buildx imagetools create \
    --tag ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION} \
    ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-linux-amd64 \
    ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-linux-arm64 \
    ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION}-windows-amd64

if [ -n "${IID_FILE}" ]; then
    docker buildx imagetools inspect --format "{{json .Manifest}}" ${REGISTRY}/${REPO}/${PROG}-runtime:${DOCKERIZED_VERSION} | jq -r '.digest' > ${IID_FILE}
fi
